name: Push Dispatch

on:
  schedule:
    - cron: "2-59/5 * * * *"
  workflow_dispatch:

jobs:
  dispatch:
    concurrency:
      group: push-dispatch
      cancel-in-progress: true
    runs-on: ubuntu-latest
    timeout-minutes: 1
    steps:
      - name: Validate secrets
        run: |
          test -n "${{ secrets.PUSH_DISPATCH_URL }}"
          test -n "${{ secrets.PUSH_DISPATCH_TOKEN }}"
      - name: Call push dispatch API
        run: |
          response_file="$(mktemp)"
          if ! http_code="$(
            curl --show-error --silent \
              --retry 2 \
              --retry-delay 5 \
              --connect-timeout 10 \
              --max-time 90 \
              -X POST \
              -H "X-Dispatch-Token: ${{ secrets.PUSH_DISPATCH_TOKEN }}" \
              -o "$response_file" \
              -w "%{http_code}" \
              "${{ secrets.PUSH_DISPATCH_URL }}"
          )"; then
            cat "$response_file"
            exit 1
          fi
          cat "$response_file"
          if [ "$http_code" -lt 200 ] || [ "$http_code" -ge 300 ]; then
            echo "push dispatch failed: HTTP $http_code" >&2
            exit 1
          fi
